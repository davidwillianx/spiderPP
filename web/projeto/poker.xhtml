<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition
    template="/WEB-INF/templates/dashboard_projeto_game.xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <ui:define name="content-dashboard" >
        <h:outputScript library="styles" name="assets/plugins/jquery-block-ui/jqueryblockui.js"/>
        <h:outputScript library="styles" name="assets/js/jquery.countdown360.js"/>
        <h:outputScript library="styles" name="assets/js/gamescript.js"/>  
        
        <div class="row">
            <div class="col-md-5 ">
                <div class="row tiles-container  m-b-20 ">
                    <div class="m-l-10 ">
                        <div class="tiles grey p-t-15 p-b-15 p-l-25 ">
                            <h4 class="text-black semi-bold">Estorias</h4>
                        </div>
                        <div class="tiles white ">
                                
                            <ui:repeat value="#{estoriaController.estorias}" var="estoria" id="index">
                                <div class="p-t-20 p-b-15 b-b b-grey">
                                    <div class="post overlap-left-10">
                                        <div class="user-profile-pic-wrapper">
                                            <div class="user-profile-pic-2x tiles blue white-border">
                                                <div class="text-white inherit-size p-t-10 p-l-15"> 
                                                    <!--<i class="fa fa-map-marker fa-lg"></i>--> 
                                                    go!
                                                </div>
                                            </div>
                                        </div>
                                        <div class="info-wrapper small-width">
                                            <div class="info text-black ">
                                                <p>#{estoria.descricao}</p>
                                                <p class="muted small-text"> data de criacao </p>
                                            </div>
                                            <div class="clearfix"></div>
                                        </div>
                                        <h:panelGroup layout="block" rendered="#{projetoController.showUserProjetoPersmission(projeto.id, usuario.id) == 1}">
                                            <div class="inline pull-right">
                                                <!--<ui:include src="/WEB-INF/templates/form_estimativa.xhtml"/>-->
                                            </div>
                                        </h:panelGroup>

                                        <div class="clearfix"></div>
                                    </div>
                                </div>

                            </ui:repeat>

                        </div>
                    </div>
                </div>
            </div> 
            
            <div class="row p-l-50">
                <div class="col-md-5">
                    <div class="grid simple">
                        <div class="grid-title">
                            <div class="row-fluid">
                                <div class="">
                                    <h4 class="text-black semi-bold">Estimativas</h4>
                                </div>
                                <h:panelGroup layout="block" class="" rendered="#{projetoController.showUserProjetoPersmission(projeto.id, usuario.id) == 1}">
                                    <a href="#" id="gameStart" class="btn btn-primary " disabled="">Iniciar</a>
                                </h:panelGroup>
                            </div>

                        </div>
                        <div class="grid-body">

                            <div class="row " id="rowSeleted">    

                            </div>
                        </div>
                    </div>
                </div>

                <h:panelGroup class="col-md-5 " layout="block" rendered="#{projetoController.showUserProjetoPersmission(projeto.id, usuario.id) == 3}">
                    <div class="grid  simple ">
                        <div class="grid-title">
                            <h3>Escolha seu card!</h3>
                        </div>

                        <div class="grid-body" id="cardSection">
                            <div class="row " >

                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="0">0</h4>
                                    </div>
                                </div>

                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="1">1</h4>
                                    </div>
                                </div>



                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5" >
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="2">2</h4>
                                    </div>
                                </div>


                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="3">3</h4>
                                    </div>
                                </div>


                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="5">5</h4>
                                    </div>
                                </div>


                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white  no-margin p-t-20 p-b-20" est="8">8</h4>
                                    </div>
                                </div>


                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="13">13</h4>
                                    </div>
                                </div>


                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="20">20</h4>
                                    </div>
                                </div>

                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card  semi-bold text-white   no-margin p-t-20 p-b-20" est="40">40</h4>
                                    </div>
                                </div>

                                <div class="col-md-1 col-xs-5 no-padding m-r-5 m-b-5">
                                    <div class="tiles green text-center">
                                        <h4 class="opt-card semi-bold text-white  no-margin p-t-20 p-b-20" est="100">100</h4>
                                    </div>
                                </div>

                            </div>
                        </div>  

                    </div>
                </h:panelGroup>
            </div>

        </div>
        
       
        
         <script type="text/javascript">
             
            $(document).ready(socketStart);
        
            function socketStart(){
               disableCardArea();
               
               var room = #{projeto.id};
               var  host = "ws://localhost:8080/spiderPP/spiderSocketGame/";
               var spiderSocket = new WebSocket(host+room);
               
               spiderSocket.onopen = function(){
                   //IF estimativa recebe tempo e as estimativas
               }
               
               $("#chat-message-input").keypress(function(messageContent){
                     if(messageContent.keyCode === 13){
                         messageContent.preventDefault();
                          
                          chatMessage = {
                               "idUsuario":  #{usuario.id},
                               "idProjeto": #{projeto.id},
                               "author" : "#{usuario.nome}",
                               "message":  $(this).val(),
                               "type":  "message"
                               
                              };
                          
                          sendMessage(spiderSocket,chatMessage);
                       }
               });
               
               spiderSocket.onmessage = function(event)
               {
                   message = JSON.parse(event.data);
                   
                   if(message.type === "message"){
                     
                     if(message.idUsuario === #{usuario.id})
                       appendMessageSent(message.message)
                     else  appendMessageReceived(message.message);
                   
                     scrollToFinish();
                   }
                   
                   if(message.type === "gameStart")
                   {
                       openGameCardSelection();
                       $("#gameStart").attr("disabled","disabled");
                       enableCardArea();
                       $("#timerGame").countdown360({
                           //seconds : 300,
                           seconds : 80,
                           onComplete: function(){
                                showCardsSelected();  
                                disableCardArea();
                                $("#gameStart").attr("disabled",false);
                                $("#timerGame").fadeOut().remove();
                           }
                       });
                   }
                   
                   if(message.type === "cardSelected")
                   {
                       card = JSON.parse(event.data); 
                       userCardSelection(card);
                   }
                   
               };
               
               $("#gameStart").click(function(e){
                   e.preventDefault();
                      gameStart = {
                       "type": "gameStart",
                       "start": "startTime"
                   };
                   console.log("enviando");
                   spiderSocket.send(JSON.stringify(gameStart));
               });
               
               $('.opt-card ').click(function(e){
                   card = {
                     "type": "cardSelected",
                     "value" : $(this).html(),
                     "userNameOption": "#{usuario.nome}",
                     "idUsuario":  #{usuario.id}
                   };
                   
                   myCardSelection(card);
                   spiderSocket.send(JSON.stringify(card));
               });
            }
         
         </script>
        
    </ui:define>


</ui:composition>
 
